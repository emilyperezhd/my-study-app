{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///Users/emilyperez/Study%20App/my-study-app/src/app/actions.ts"],"sourcesContent":["'use server'\n\nimport { db } from \"../lib/db\";\nimport { revalidatePath } from \"next/cache\";\nimport { ChatOpenAI } from \"@langchain/openai\";\nimport { PromptTemplate } from \"@langchain/core/prompts\";\n\n// @ts-ignore\nimport PDFParser from \"pdf2json\";\n\nexport async function uploadPdf(formData: FormData) {\n  try {\n    const file = formData.get(\"file\") as File;\n    if (!file) throw new Error(\"No file found\");\n\n    const arrayBuffer = await file.arrayBuffer();\n    const buffer = Buffer.from(arrayBuffer);\n\n    // --- ORIGINAL METHOD (With Crash Protection) ---\n    const text = await new Promise<string>((resolve, reject) => {\n        const parser = new PDFParser(null, 1); // 1 = Raw Text Mode\n\n        parser.on(\"pdfParser_dataError\", (errData: any) => {\n            console.error(errData.parserError);\n            resolve(\"\"); // If it fails, just return empty text (don't crash)\n        });\n\n        parser.on(\"pdfParser_dataReady\", () => {\n            try {\n                // This is the line that was crashing on specific files.\n                // We wrap it so if it fails, we just save a placeholder message.\n                const raw = parser.getRawTextContent();\n                resolve(raw);\n            } catch (error) {\n                console.error(\"Text extraction error:\", error);\n                resolve(\"Text could not be extracted from this specific PDF.\");\n            }\n        });\n\n        // Start parsing\n        try {\n            parser.parseBuffer(buffer);\n        } catch (e) {\n            resolve(\"\");\n        }\n    });\n    // --------------------------------\n\n    // If text is empty (or failed), use a placeholder\n    const finalContent = typeof text === 'string' && text.trim().length > 0 \n        ? text \n        : \"Text could not be extracted from this PDF.\";\n\n    await db.course.create({\n      data: {\n        title: file.name,\n        content: finalContent,\n      }\n    });\n\n    revalidatePath(\"/\");\n  } catch (error) {\n    console.error(\"Upload Error:\", error);\n  }\n}\n\nexport async function generateStudyGuide(id: string) {\n  try {\n    const note = await db.course.findUnique({ where: { id: id } });\n    if (!note || !note.content) throw new Error(\"Note not found\");\n\n    const model = new ChatOpenAI({ \n      modelName: \"gpt-4o-mini\", \n      openAIApiKey: process.env.OPENAI_API_KEY \n    });\n\n    const prompt = PromptTemplate.fromTemplate(\n      `You are a strict academic tutor. Create a structured study guide.\n       Rules: HTML format only, use <h1>, <h2>, <ul>, <strong>. No Markdown.\n       Text: {text}`\n    );\n\n    const chain = prompt.pipe(model);\n    const response = await chain.invoke({ text: note.content.slice(0, 15000) });\n\n    await db.course.update({\n      where: { id: id },\n      data: { summary: response.content as string }\n    });\n\n    revalidatePath(`/notes/${id}`);\n  } catch (error) {\n    console.error(\"AI Study Guide Error:\", error);\n  }\n}\n\nexport async function generateQuiz(id: string) {\n  try {\n    const note = await db.course.findUnique({ where: { id: id } });\n    if (!note || !note.content) throw new Error(\"Note not found\");\n\n    const model = new ChatOpenAI({\n      modelName: \"gpt-4o-mini\",\n      openAIApiKey: process.env.OPENAI_API_KEY,\n      temperature: 0.1, \n      modelKwargs: { response_format: { type: \"json_object\" } } \n    });\n\n    const prompt = PromptTemplate.fromTemplate(\n      `Generate 5 difficult multiple-choice questions based on the provided text.\n       Return JSON object: {{ \"questions\": [ {{ \"question\": \"...\", \"options\": [\"...\"], \"answer\": \"...\" }} ] }}\n       Text: {text}`\n    );\n\n    const chain = prompt.pipe(model);\n    const response = await chain.invoke({ text: note.content.slice(0, 15000) });\n    \n    const content = typeof response.content === 'string' ? response.content : JSON.stringify(response.content);\n    const data = JSON.parse(content);\n    \n    await db.question.createMany({\n      data: data.questions.map((q: any) => ({\n        courseId: id,\n        question: q.question,\n        options: q.options,\n        answer: q.answer\n      }))\n    });\n\n    revalidatePath(`/notes/${id}`);\n  } catch (error) {\n    console.error(\"AI Quiz Error:\", error);\n  }\n}\n\nexport async function saveQuizResult(courseId: string, score: number, total: number) {\n  try {\n    // We already fixed the database table issue, so this will work now.\n    await db.quizResult.create({\n      data: {\n        courseId,\n        score,\n        total,\n      },\n    });\n    revalidatePath(`/notes/${courseId}`);\n  } catch (error) {\n    console.error(\"Save Error:\", error);\n  }\n}\n\nexport async function deleteCourse(id: string) {\n  try {\n    await db.course.delete({\n      where: { id: id }\n    });\n    revalidatePath(\"/\");\n  } catch (error) {\n    console.error(\"Delete Error:\", error);\n  }\n}\n\nexport async function renameCourse(id: string, newTitle: string) {\n  try {\n    await db.course.update({\n      where: { id: id },\n      data: { title: newTitle }\n    });\n    revalidatePath(\"/\");\n  } catch (error) {\n    console.error(\"Rename Error:\", error);\n  }\n}"],"names":[],"mappings":";;;;;;;IAuIsB,iBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA"}},
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///Users/emilyperez/Study%20App/my-study-app/src/components/QuizApp.tsx"],"sourcesContent":["\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { saveQuizResult } from \"../app/actions\"; // <--- Import the action\n\ntype Question = {\n  id: string;\n  question: string;\n  options: string[];\n  answer: string;\n};\n\n// We need the courseId to know WHERE to save the result\nexport default function QuizApp({ \n  questions, \n  courseId \n}: { \n  questions: Question[], \n  courseId: string \n}) {\n  const [currentQuestion, setCurrentQuestion] = useState(0);\n  const [score, setScore] = useState(0);\n  const [showScore, setShowScore] = useState(false);\n  const [selectedOption, setSelectedOption] = useState<string | null>(null);\n  \n  const handleAnswer = async (option: string) => { // Made async\n    const correct = option === questions[currentQuestion].answer;\n    setSelectedOption(option);\n    \n    // Calculate new score immediately so we don't wait for state update\n    const newScore = correct ? score + 1 : score;\n    if (correct) setScore(newScore);\n\n    // Wait 1 second\n    setTimeout(async () => {\n      const nextQuestion = currentQuestion + 1;\n      if (nextQuestion < questions.length) {\n        setCurrentQuestion(nextQuestion);\n        setSelectedOption(null);\n      } else {\n        setShowScore(true);\n        // --- SAVE THE RESULT ---\n        await saveQuizResult(courseId, newScore, questions.length);\n      }\n    }, 1000);\n  };\n\n  const resetQuiz = () => {\n    setCurrentQuestion(0);\n    setScore(0);\n    setShowScore(false);\n    setSelectedOption(null);\n  };\n\n  if (questions.length === 0) return null;\n\n  return (\n    <div className=\"bg-white p-8 rounded-xl shadow-lg border border-orange-200 mt-8\">\n      <div className=\"flex justify-between items-center mb-6\">\n        <h2 className=\"text-2xl font-bold text-orange-600\">ðŸ§  Practice Quiz</h2>\n        {!showScore && (\n          <span className=\"text-sm font-medium text-gray-500 bg-gray-100 px-3 py-1 rounded-full\">\n            {currentQuestion + 1} / {questions.length}\n          </span>\n        )}\n      </div>\n\n      {showScore ? (\n        <div className=\"text-center py-10\">\n          <div className=\"text-6xl mb-4\">{score === questions.length ? \"ðŸŽ‰\" : \"ðŸ“ˆ\"}</div>\n          <p className=\"text-2xl font-bold text-gray-800 mb-2\">\n            You scored {score} out of {questions.length}\n          </p>\n          <p className=\"text-green-600 font-bold mb-6\">Result Saved! âœ…</p>\n          <button \n            onClick={resetQuiz}\n            className=\"bg-orange-600 text-white px-8 py-3 rounded-xl font-semibold hover:bg-orange-700 transition\"\n          >\n            Retake Quiz\n          </button>\n        </div>\n      ) : (\n        <div>\n          <h3 className=\"text-xl font-semibold mb-8 text-gray-800 leading-relaxed\">\n            {questions[currentQuestion].question}\n          </h3>\n          <div className=\"grid gap-4\">\n            {questions[currentQuestion].options.map((option, index) => {\n              let btnClass = \"p-5 rounded-xl border-2 text-left transition-all font-medium \";\n              if (selectedOption) {\n                 if (option === questions[currentQuestion].answer) btnClass += \"bg-green-50 border-green-500 text-green-700\";\n                 else if (option === selectedOption) btnClass += \"bg-red-50 border-red-500 text-red-700\";\n                 else btnClass += \"bg-gray-50 border-gray-100 text-gray-400 opacity-50\";\n              } else {\n                 btnClass += \"bg-white border-gray-200 hover:border-orange-400 hover:bg-orange-50 text-gray-700\";\n              }\n              return (\n                <button\n                  key={index}\n                  onClick={() => !selectedOption && handleAnswer(option)}\n                  disabled={!!selectedOption}\n                  className={btnClass}\n                >\n                  <span className=\"mr-3 text-gray-400 font-mono text-sm\">{String.fromCharCode(65 + index)}.</span>\n                  {option}\n                </button>\n              );\n            })}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}"],"names":[],"mappings":";;;;;AAEA;AACA,4PAAiD,yBAAyB;AAH1E;;;;AAae,SAAS,QAAQ,EAC9B,SAAS,EACT,QAAQ,EAIT;IACC,MAAM,CAAC,iBAAiB,mBAAmB,GAAG,IAAA,iNAAQ,EAAC;IACvD,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,iNAAQ,EAAC;IACnC,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,iNAAQ,EAAC;IAC3C,MAAM,CAAC,gBAAgB,kBAAkB,GAAG,IAAA,iNAAQ,EAAgB;IAEpE,MAAM,eAAe,OAAO;QAC1B,MAAM,UAAU,WAAW,SAAS,CAAC,gBAAgB,CAAC,MAAM;QAC5D,kBAAkB;QAElB,oEAAoE;QACpE,MAAM,WAAW,UAAU,QAAQ,IAAI;QACvC,IAAI,SAAS,SAAS;QAEtB,gBAAgB;QAChB,WAAW;YACT,MAAM,eAAe,kBAAkB;YACvC,IAAI,eAAe,UAAU,MAAM,EAAE;gBACnC,mBAAmB;gBACnB,kBAAkB;YACpB,OAAO;gBACL,aAAa;gBACb,0BAA0B;gBAC1B,MAAM,IAAA,oKAAc,EAAC,UAAU,UAAU,UAAU,MAAM;YAC3D;QACF,GAAG;IACL;IAEA,MAAM,YAAY;QAChB,mBAAmB;QACnB,SAAS;QACT,aAAa;QACb,kBAAkB;IACpB;IAEA,IAAI,UAAU,MAAM,KAAK,GAAG,OAAO;IAEnC,qBACE,8OAAC;QAAI,WAAU;;0BACb,8OAAC;gBAAI,WAAU;;kCACb,8OAAC;wBAAG,WAAU;kCAAqC;;;;;;oBAClD,CAAC,2BACA,8OAAC;wBAAK,WAAU;;4BACb,kBAAkB;4BAAE;4BAAI,UAAU,MAAM;;;;;;;;;;;;;YAK9C,0BACC,8OAAC;gBAAI,WAAU;;kCACb,8OAAC;wBAAI,WAAU;kCAAiB,UAAU,UAAU,MAAM,GAAG,OAAO;;;;;;kCACpE,8OAAC;wBAAE,WAAU;;4BAAwC;4BACvC;4BAAM;4BAAS,UAAU,MAAM;;;;;;;kCAE7C,8OAAC;wBAAE,WAAU;kCAAgC;;;;;;kCAC7C,8OAAC;wBACC,SAAS;wBACT,WAAU;kCACX;;;;;;;;;;;qCAKH,8OAAC;;kCACC,8OAAC;wBAAG,WAAU;kCACX,SAAS,CAAC,gBAAgB,CAAC,QAAQ;;;;;;kCAEtC,8OAAC;wBAAI,WAAU;kCACZ,SAAS,CAAC,gBAAgB,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,QAAQ;4BAC/C,IAAI,WAAW;4BACf,IAAI,gBAAgB;gCACjB,IAAI,WAAW,SAAS,CAAC,gBAAgB,CAAC,MAAM,EAAE,YAAY;qCACzD,IAAI,WAAW,gBAAgB,YAAY;qCAC3C,YAAY;4BACpB,OAAO;gCACJ,YAAY;4BACf;4BACA,qBACE,8OAAC;gCAEC,SAAS,IAAM,CAAC,kBAAkB,aAAa;gCAC/C,UAAU,CAAC,CAAC;gCACZ,WAAW;;kDAEX,8OAAC;wCAAK,WAAU;;4CAAwC,OAAO,YAAY,CAAC,KAAK;4CAAO;;;;;;;oCACvF;;+BANI;;;;;wBASX;;;;;;;;;;;;;;;;;;AAMZ"}}]
}